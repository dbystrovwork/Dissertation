"""
Network Visualization Demonstration

Visualizes various graph types generated by the codebase to understand
their structure, community organization, and phase patterns.
"""

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))

import argparse
from src.graphs import (
    generate_csbm,
    generate_csbm_unbalanced,
    generate_hierarchical_dag,
    generate_directed_cycle,
    generate_small_world,
    generate_tree,
)
from src.graphs.generators import generate_small_graph
from src.visualization import visualize_graph, visualize_csbm_structure, compare_networks


def visualize_csbm_examples(output_dir: Path):
    """Visualize CSBM with different balance configurations."""
    print("\n" + "="*80)
    print("Visualizing CSBM Graphs")
    print("="*80)

    # 1. Balanced CSBM (eta=0)
    print("\n1. Balanced Phase-Structured CSBM (eta=0)")
    edge_index, labels, meta = generate_csbm(
        n_communities=2,
        community_size=30,
        p_in=0.6,
        p_out=0.1,
        eta=0.0,
        sub_communities_per_comm=[3, 3],
        seed=42
    )

    # Add level1_labels to metadata for visualization
    n_total = len(labels)
    level1_labels = labels.clone()
    meta['level1_labels'] = level1_labels

    visualize_csbm_structure(
        edge_index,
        meta,
        title="Balanced CSBM (eta=0.0, 3 sub-communities per community)",
        save_path=output_dir / "csbm_balanced.png"
    )

    # 2. Phase-Mixed CSBM (eta=0.2)
    print("2. Phase-Mixed CSBM (eta=0.2)")
    edge_index, labels, meta = generate_csbm(
        n_communities=2,
        community_size=30,
        p_in=0.6,
        p_out=0.1,
        eta=0.2,
        sub_communities_per_comm=[3, 3],
        seed=42
    )
    meta['level1_labels'] = labels.clone()

    visualize_csbm_structure(
        edge_index,
        meta,
        title="Phase-Mixed CSBM (eta=0.2, 20% phases randomized)",
        save_path=output_dir / "csbm_mixed.png"
    )

    # 3. Strictly Unbalanced CSBM
    print("3. Strictly Unbalanced CSBM")
    edge_index, labels, meta = generate_csbm_unbalanced(
        n_communities=2,
        community_size=30,
        p_in=0.6,
        p_out=0.1,
        seed=42
    )
    meta['level1_labels'] = labels.clone()

    visualize_csbm_structure(
        edge_index,
        meta,
        title="Strictly Unbalanced CSBM (random phases)",
        save_path=output_dir / "csbm_unbalanced.png"
    )


def visualize_hierarchical_examples(output_dir: Path):
    """Visualize hierarchical DAGs."""
    print("\n" + "="*80)
    print("Visualizing Hierarchical DAGs")
    print("="*80)

    for num_levels in [3, 4, 5]:
        print(f"Hierarchical DAG with {num_levels} levels")
        edge_index, labels = generate_hierarchical_dag(
            n=60,
            num_levels=num_levels,
            p_forward=0.3,
            p_skip=0.1,
            p_lateral=0.05
        )

        visualize_graph(
            edge_index,
            labels,
            title=f"Hierarchical DAG ({num_levels} levels)",
            layout="spring",
            save_path=output_dir / f"hierarchical_{num_levels}levels.png"
        )


def visualize_small_pedagogical_graphs(output_dir: Path):
    """Visualize small pedagogical graphs."""
    print("\n" + "="*80)
    print("Visualizing Pedagogical Graphs")
    print("="*80)

    graph_names = [
        "triangle_cycle",
        "diamond",
        "cycle_4",
        "star_out",
        "hexagon",
        "two_triangles",
        "hierarchical_3level"
    ]

    graphs_for_comparison = []

    for name in graph_names:
        print(f"Generating {name}")
        edge_index, num_nodes, description = generate_small_graph(name)

        # Create simple labels (just node indices)
        import torch
        labels = torch.arange(num_nodes, dtype=torch.long)

        visualize_graph(
            edge_index,
            labels,
            title=f"{name}\n{description}",
            layout="spring" if "hierarchical" not in name else "kamada_kawai",
            node_size=500,
            save_path=output_dir / f"pedagogical_{name}.png",
            show_legend=False
        )

        # Collect for comparison
        graphs_for_comparison.append((edge_index, labels, None, name))

    # Create comparison figure
    print("\nCreating comparison figure")
    compare_networks(
        graphs_for_comparison,
        save_path=output_dir / "pedagogical_comparison.png"
    )


def visualize_other_graph_types(output_dir: Path):
    """Visualize other graph types (cycles, trees, small-world)."""
    print("\n" + "="*80)
    print("Visualizing Other Graph Types")
    print("="*80)

    # Directed cycle
    print("1. Directed Cycle")
    edge_index, labels = generate_directed_cycle(n=20)
    visualize_graph(
        edge_index,
        labels,
        title="Directed Cycle (n=20)",
        layout="circular",
        save_path=output_dir / "directed_cycle.png"
    )

    # Tree
    print("2. Binary Tree")
    edge_index, labels = generate_tree(n=31, branching=2, directed=True)
    visualize_graph(
        edge_index,
        labels,
        title="Binary Tree (directed, depth-based labels)",
        layout="kamada_kawai",
        save_path=output_dir / "binary_tree.png"
    )

    # Small-world
    print("3. Small-World Graph")
    edge_index, labels = generate_small_world(n=40, k=4, p=0.2, directed=True)
    visualize_graph(
        edge_index,
        labels,
        title="Small-World Graph (n=40, k=4, p=0.2)",
        layout="spring",
        save_path=output_dir / "small_world.png"
    )


def create_csbm_comparison(output_dir: Path):
    """Create side-by-side comparison of balanced, mixed, and unbalanced CSBM."""
    print("\n" + "="*80)
    print("Creating CSBM Comparison Figure")
    print("="*80)

    graphs = []

    configs = [
        ("Balanced (eta=0)", 0.0),
        ("Mixed (eta=0.1)", 0.1),
        ("Mixed (eta=0.2)", 0.2),
    ]

    for title, eta in configs:
        edge_index, labels, meta = generate_csbm(
            n_communities=2,
            community_size=20,
            p_in=0.6,
            p_out=0.1,
            eta=eta,
            sub_communities_per_comm=[3, 3],
            seed=42
        )
        graphs.append((edge_index, labels, meta['edge_phases'], title))

    # Add unbalanced
    edge_index, labels, meta = generate_csbm_unbalanced(
        n_communities=2,
        community_size=20,
        p_in=0.6,
        p_out=0.1,
        seed=42
    )
    graphs.append((edge_index, labels, meta['edge_phases'], "Unbalanced"))

    compare_networks(
        graphs,
        save_path=output_dir / "csbm_comparison.png"
    )


def main():
    parser = argparse.ArgumentParser(description="Visualize various graph types")
    parser.add_argument('--output-dir', default='results/visualizations',
                       help='Output directory for visualizations')
    parser.add_argument('--examples', nargs='+',
                       choices=['csbm', 'hierarchical', 'pedagogical', 'other', 'comparison', 'all'],
                       default=['all'],
                       help='Which examples to generate')
    args = parser.parse_args()

    output_dir = Path(args.output_dir)
    output_dir.mkdir(parents=True, exist_ok=True)

    print("Network Visualization Demonstration")
    print("="*80)
    print(f"Output directory: {output_dir}")

    examples = args.examples
    if 'all' in examples:
        examples = ['csbm', 'hierarchical', 'pedagogical', 'other', 'comparison']

    if 'csbm' in examples:
        visualize_csbm_examples(output_dir)

    if 'hierarchical' in examples:
        visualize_hierarchical_examples(output_dir)

    if 'pedagogical' in examples:
        visualize_small_pedagogical_graphs(output_dir)

    if 'other' in examples:
        visualize_other_graph_types(output_dir)

    if 'comparison' in examples:
        create_csbm_comparison(output_dir)

    print("\n" + "="*80)
    print("All visualizations complete!")
    print(f"Results saved to: {output_dir}")
    print("="*80)


if __name__ == "__main__":
    main()
